#!/usr/bin/env node

import { execFileSync } from 'node:child_process';
import { readFileSync } from 'node:fs';
import { fileURLToPath } from 'node:url';
import { dirname, join } from 'node:path';
import { homedir } from 'node:os';

const ROOT = dirname(
  dirname(fileURLToPath(import.meta.url))
);

const COMMANDS = new Set([
  'report', 'backfill',
]);

const DEFAULT_ARGS = ['--week'];

const USAGE = `Usage: claudelog [command] [options]

Commands:
  report     Generate time reports
  backfill   Import historical transcripts

With no arguments, runs a default report
(configurable via defaultReport in
config.json).

Run claudelog <command> --help for details.

Examples:
  claudelog
  claudelog report --week --by-project
  claudelog report --month --timesheet
  claudelog backfill`;

function loadDefaultReport() {
  const dir =
    process.env.CLAUDE_TIMELOG_DIR ||
    join(homedir(), '.claude', 'timelog');
  try {
    const raw = readFileSync(
      join(dir, 'config.json'), 'utf8'
    );
    const cfg = JSON.parse(raw);
    if (Array.isArray(cfg.defaultReport)) {
      return cfg.defaultReport;
    }
  } catch {
    // No config or invalid JSON â€” use default
  }
  return DEFAULT_ARGS;
}

function dispatch(script, args) {
  try {
    execFileSync(
      process.execPath,
      [script, ...args],
      { stdio: 'inherit' }
    );
  } catch (err) {
    process.exit(err.status ?? 1);
  }
}

const cmd = process.argv[2];

if (cmd === '--help' || cmd === 'help') {
  process.stdout.write(USAGE + '\n');
  process.exit(0);
}

if (!cmd) {
  const args = loadDefaultReport();
  dispatch(
    join(ROOT, 'scripts', 'report.mjs'),
    args
  );
} else if (COMMANDS.has(cmd)) {
  dispatch(
    join(ROOT, 'scripts', `${cmd}.mjs`),
    process.argv.slice(3)
  );
} else {
  process.stderr.write(
    `Unknown command: ${cmd}\n\n${USAGE}\n`
  );
  process.exit(1);
}
